name: Deploy UI (App Service Container)

on:
  push:
    branches: [ "main" ]
    paths:
      - "ui/**"
      - ".github/workflows/ui-appservice-deploy.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - qa
          - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy-ui:
    runs-on: ubuntu-latest
    env:
      ENV_NAME: ${{ github.event.inputs.environment || 'dev' }}

      TF_STATE_RG: ${{ secrets.TF_STATE_RG }}
      TF_STATE_STORAGE: ${{ secrets.TF_STATE_STORAGE }}
      TF_STATE_CONTAINER: ${{ secrets.TF_STATE_CONTAINER }}

      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      SUBSCRIPTION_ID: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Setup Terraform (for outputs)
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init (remote state)
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="resource_group_name=${TF_STATE_RG}" \
            -backend-config="storage_account_name=${TF_STATE_STORAGE}" \
            -backend-config="container_name=${TF_STATE_CONTAINER}" \
            -backend-config="key=infra.tfstate"

      - name: Read Terraform outputs
        working-directory: terraform
        run: terraform output -json > tfout.json

      - name: Resolve infra names + APIM URL for environment
        working-directory: terraform
        run: |
          RG=$(jq -r --arg env "$ENV_NAME" '.resource_groups.value[$env]' tfout.json)
          WEBAPP=$(jq -r --arg env "$ENV_NAME" '.ui_webapp_names.value[$env]' tfout.json)
          APIM_URL=$(jq -r --arg env "$ENV_NAME" '.apim_gateway_urls.value[$env]' tfout.json)

          echo "RG=$RG" >> $GITHUB_ENV
          echo "WEBAPP=$WEBAPP" >> $GITHUB_ENV
          echo "APIM_URL=$APIM_URL" >> $GITHUB_ENV

      - name: Build & Push UI image (inject APIM URL)
        working-directory: ui
        run: |
          IMAGE_UI="${DOCKER_USERNAME}/gopal-ui:${ENV_NAME}-${GITHUB_SHA}"
          docker build \
            --build-arg REACT_APP_API_BASE_URL="${APIM_URL}" \
            -t "$IMAGE_UI" .
          docker push "$IMAGE_UI"
          echo "IMAGE_UI=$IMAGE_UI" >> $GITHUB_ENV

      - name: Point App Service to UI container image
        run: |
          az webapp config container set \
            --resource-group "$RG" \
            --name "$WEBAPP" \
            --docker-custom-image-name "docker.io/$IMAGE_UI" \
            --docker-registry-server-url "https://index.docker.io"

          az webapp config appsettings set \
            --resource-group "$RG" \
            --name "$WEBAPP" \
            --settings WEBSITES_PORT=80

          az webapp restart --resource-group "$RG" --name "$WEBAPP"
